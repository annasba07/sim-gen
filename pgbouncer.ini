# PgBouncer Configuration for SimGen AI
# Efficient PostgreSQL connection pooling to prevent database saturation

[databases]
simgen = host=postgres port=5432 dbname=simgen user=simgen password=simgen
simgen_read = host=postgres port=5432 dbname=simgen user=simgen password=simgen

[pgbouncer]
# Connection pooling mode
# transaction: Best for most applications (recommended)
# session: One connection per client session
# statement: Most aggressive pooling
pool_mode = transaction

# Listen on all interfaces
listen_addr = 0.0.0.0
listen_port = 6432

# Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Connection limits
max_client_conn = 1000       # Maximum client connections
default_pool_size = 25       # Default pool size per database
max_db_connections = 100     # Maximum database connections per database
max_user_connections = 100   # Maximum connections per user

# Reserve pool for emergency connections
reserve_pool_size = 5
reserve_pool_timeout = 5

# Connection timeouts (in seconds)
server_connect_timeout = 15
server_login_retry = 15
server_idle_timeout = 600
server_lifetime = 3600
client_idle_timeout = 0
client_login_timeout = 60

# Query timeout
query_timeout = 120
query_wait_timeout = 120

# Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60

# Performance tuning
pkt_buf = 4096
max_packet_size = 2147483647

# DNS settings
dns_max_ttl = 15
dns_nxdomain_ttl = 15
dns_zone_check_period = 0

# Application name to appear in PostgreSQL logs
application_name_add_host = 1

# Cleanup
server_reset_query = DISCARD ALL
server_reset_query_always = 0
server_check_query = SELECT 1
server_check_delay = 30

# Ignore startup parameters that pgbouncer doesn't understand
ignore_startup_parameters = extra_float_digits

# Admin interface
admin_users = simgen
stats_users = simgen

# Security
disable_pqexec = 0

# Transaction bracketing
track_extra_parameters = 0

# Unix socket (not used in Docker, but good practice)
unix_socket_dir = /tmp
unix_socket_mode = 0777
unix_socket_group =